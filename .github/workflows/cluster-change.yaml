name: "Cluster: Modify JSON Data"
on:
  workflow_dispatch:
    inputs:
      name:
        type: string
      region:
        type: string
      environment:
        type: string
      port_payload:
        required: true
        description: Port's payload, including details for who triggered the action and
          general context (blueprint, run id, etc...)
        type: string
jobs:
  change:
    name: Change and Push
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      with:
        fetch-depth: 0
    - name: Modify cluster data
      run: |
        FILE=input-port.json
        cd clusters

        echo "Previous State:"
        cat $FILE

        if [ "${{ fromJson(inputs.port_payload).payload.action.trigger }}" = "CREATE" ]; then
          JSON=$(jq ".clusters[.clusters | length] |= {
            \"name\": \"${{ inputs.name }}\",
            \"resource_group_name\": \"kubernetes-solution-${{ inputs.name }}-${{ inputs.environment }}\",
            \"resource_group_location\": \"${{ inputs.region }}\",
            \"environment\": \"${{ inputs.environment }}\",
          }" $FILE)
        else
          JSON=$(jq "del(.clusters[] | select(.name == \"${{ fromJson(inputs.port_payload).payload.entity.identifier }}\"))" $FILE)
        fi

        echo "$JSON" > $FILE

        echo "New State:"
        cat $FILE
    - name: Commit & Push changes
      uses: actions-js/push@master
      with:
        message: "ğŸ…¿ï¸ Port Action: ${{ fromJson(inputs.port_payload).payload.action.trigger == 'CREATE' && 'Add' || 'Delete' }} cluster '${{ fromJson(inputs.port_payload).payload.action.trigger == 'CREATE' && inputs.name || fromJson(inputs.port_payload).payload.entity.identifier }}'\nTriggered by: ${{ fromJson(inputs.port_payload).trigger.by.user.firstName }} ${{ fromJson(inputs.port_payload).trigger.by.user.lastName }}"
        github_token: ${{ github.token }}
